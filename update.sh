#!/bin/bash

# اسکریپت به‌روزرسانی ربات با لاگ کامل

# تابع برای چاپ لاگ با تاریخ و ساعت
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] - $1"
}

log "=== شروع فرآیند به‌روزرسانی ربات ==="

# به مسیر دایرکتوری ربات بروید
cd "$(dirname "$0")" || { log "خطا: ورود به دایرکتوری اسکریپت ناموفق بود."; exit 1; }
log "مسیر فعلی: $(pwd)"

log "در حال دریافت آخرین تغییرات از گیت..."
# دریافت آخرین تغییرات از شاخه اصلی (main یا master)
if git pull origin main; then
    log "✅ تغییرات با موفقیت از گیت دریافت شد."
else
    log "❌ خطا در هنگام دریافت تغییرات از گیت. فرآیند متوقف شد."
    exit 1
fi

log "در حال نصب یا به‌روزرسانی کتابخانه‌های مورد نیاز..."
# نصب وابستگی‌ها از فایل requirements.txt
if pip install -r requirements.txt; then
    log "✅ کتابخانه‌ها با موفقیت نصب یا به‌روزرسانی شدند."
else
    log "⚠️ هشدار: خطایی در هنگام نصب کتابخانه‌ها رخ داد. ادامه می‌دهیم..."
fi

log "ریبوت کردن سرویس ربات..."
# سرویس ربات را ری‌استارت کنید (نام سرویس خود را جایگزین کنید)
if systemctl restart monitor_bot.service; then
    log "✅ درخواست ری‌استارت سرویس با موفقیت ارسال شد."
else
    log "❌ خطا در ری‌استارت کردن سرویس ربات."
    exit 1
fi

log "=== فرآیند به‌روزرسانی با موفقیت به پایان رسید ==="